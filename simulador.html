function init() {
    scene = new THREE.Scene();
    const container = document.getElementById('canvas-container');
    
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 10000);
    camera.position.set(0, 0, 10); 

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    // Mejora el color para que no se vea lavado
    renderer.outputEncoding = THREE.sRGBEncoding; 
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Iluminación optimizada
    scene.add(new THREE.AmbientLight(0xffffff, 1.2));
    const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
    light1.position.set(5, 10, 7);
    scene.add(light1);

    const loader = new THREE.GLTFLoader();
    // Cargamos el modelo con un bypass de caché
    loader.load('tshirt.glb?v=' + Date.now(), (gltf) => {
        shirtModel = gltf.scene;
        
        const box = new THREE.Box3().setFromObject(shirtModel);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());

        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 5 / maxDim; 
        shirtModel.scale.set(scale, scale, scale);
        // Centrar el modelo en el origen (0,0,0)
        shirtModel.position.sub(center.multiplyScalar(scale));
        
        scene.add(shirtModel);
        updateMaterial(); // Aplicar estado inicial
        console.log("Camiseta J&J cargada correctamente");
    }, undefined, (error) => {
        console.error("Error al cargar el archivo GLB:", error);
    });

    animate(); // Asegúrate de que la función se llame animate y no animar
}

function updateMaterial() {
    if (!shirtModel) return;

    const colorValue = document.getElementById('shirt-color').value;
    const scaleFactor = parseFloat(document.getElementById('logo-scale').value);
    const posY = parseFloat(document.getElementById('logo-y').value);

    // Invertimos la escala para que al subir el slider el logo crezca
    const s = 1 / scaleFactor;

    shirtModel.traverse((child) => {
        if (child.isMesh) {
            // Clonamos el material para no afectar a otras partes si el modelo es complejo
            if (!child.userData.originalMaterial) {
                child.userData.originalMaterial = child.material.clone();
                child.material = child.userData.originalMaterial;
            }

            child.material.color.set(colorValue);

            if (designTexture) {
                child.material.map = designTexture;
                designTexture.wrapS = designTexture.wrapT = THREE.ClampToEdgeWrapping;
                
                // Ajuste de repetición
                child.material.map.repeat.set(s, s);
                
                // AJUSTE CRÍTICO DE POSICIÓN
                // 0.5 es el centro de la textura. Ajustamos según la escala y el slider Y
                child.material.map.offset.set(0.5 - (s / 2), posY);
                
                child.material.map.needsUpdate = true;
            }
            child.material.needsUpdate = true;
        }
    });
}
