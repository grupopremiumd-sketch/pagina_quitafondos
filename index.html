<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>J&J Studio Pro — Quitafondos Elite</title>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --text:#eeeeee; --muted:#9ca3af;
      --accent:#6366f1; --accent-2:#0ea5e9; --border:#1f1f1f;
      --success-1:#10b981; --success-2:#22c55e; --vip:#00d2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;background:#0b0b0b;position:sticky;top:0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:900;color:var(--vip);letter-spacing:.5px}
    
    .wrap{display:grid;grid-template-columns:350px 1fr;gap:16px;height:calc(100vh - 58px);padding:16px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr; overflow-y:auto;}}
    
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:15px;overflow-y:auto}
    .panel h2{font-size:13px;font-weight:800;margin:15px 0 8px;color:var(--muted);text-transform:uppercase}
    
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0}
    label{font-size:13px;color:#e5e7eb}
    
    input, select, button{background:#1a1a1a;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px}
    input[type="range"]{width:100%;accent-color:var(--vip)}
    
    .btn-nav{width:100%;background:#222;color:var(--vip);border:1px solid var(--vip);padding:10px;cursor:pointer;font-weight:800;margin-bottom:10px;border-radius:8px}
    .btn-download{background:linear-gradient(135deg,var(--success-1),var(--success-2));border:none;color:#052e1a;padding:12px;border-radius:8px;cursor:pointer;font-weight:900;width:100%;margin-top:15px}
    
    .canvasWrap{position:relative;background:#0b0b0b;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    canvas#canvas{display:block;transform-origin:top left; cursor: crosshair;}
    
    /* Selector de Color Lienzo Pro */
    .cp-wrap{display:flex;gap:10px;margin-top:10px}
    #cpSV{border-radius:6px;border:1px solid #2a2a2a;cursor:crosshair; touch-action:none; background:#000;}
    #cpH{border-radius:6px;border:1px solid #2a2a2a;cursor:ns-resize; touch-action:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(500px,92vw);background:#121212;border:1px solid #262626;border-radius:14px;padding:25px}
    .hidden{display:none!important}
  </style>
</head>
<body>

  <header><h1>J&J STUDIO PRO — QUITAFONDOS</h1></header>

  <main class="wrap">
    <section class="panel">
      <button class="btn-nav" onclick="location.href='simulador.html'">✨ IR AL SIMULADOR</button>
      
      <h2>1. Cargar imagen</h2>
      <input id="file" type="file" accept="image/*">

      <h2>2. Configuración</h2>
      <div class="row">
        <label>Modo</label>
        <select id="mode">
          <option value="white">Quitar blanco</option>
          <option value="black">Quitar negro</option>
          <option value="pick">Elegir color (clic imagen)</option>
        </select>
        <input id="colorInp" type="color" value="#ffffff">
      </div>
      <div class="row"><label>Tolerancia</label><input id="fuzz" type="range" min="0" max="200" value="60"></div>
      
      <h2>3. Color del lienzo</h2>
      <div class="cp-wrap">
        <canvas id="cpSV" width="220" height="120"></canvas>
        <canvas id="cpH" width="20" height="120"></canvas>
      </div>

      <button id="reset" style="width:100%; margin-top:20px; background:transparent">Reiniciar</button>
      <button id="btnOpenExport" class="btn-download">DESCARGAR PNG</button>
    </section>

    <section class="canvasWrap" id="stage">
      <canvas id="canvas"></canvas>
    </section>
  </main>

  <div id="exportModal" class="modal-backdrop hidden">
    <div class="modal">
      <h3 style="margin:0 0 20px 0; color:var(--vip)">Opciones de Exportación VIP</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
        <div class="row"><label>Ancho (px)</label><input id="exW" type="number"></div>
        <div class="row"><label>Alto (px)</label><input id="exH" type="number"></div>
        <div class="row">
            <label>Remuestreo</label>
            <select id="exMethod">
                <option value="nearest">Nearest (Rápido)</option>
                <option value="bilinear" selected>Bilinear (Bueno)</option>
            </select>
        </div>
        <div class="row"><label>DPI</label><input id="exDPI" type="number" value="300"></div>
      </div>
      
      <div id="vip-warning" style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:11px; color:var(--muted)">
        ⚠️ La descarga en alta calidad es para miembros de la <b>Comunidad J&J</b>.
      </div>

      <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end">
        <button onclick="document.getElementById('exportModal').classList.add('hidden')">Cancelar</button>
        <button id="btnFinalSave" style="background:var(--success-1); color:#000; font-weight:bold; border:none; padding:10px 25px; border-radius:8px; cursor:pointer">DESCARGAR</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      let isVip = localStorage.getItem('jj_session') === 'active';
      const fileInp=document.getElementById('file'), canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
      const mode=document.getElementById('mode'), colorInp=document.getElementById('colorInp'), fuzz=document.getElementById('fuzz');
      const stage=document.getElementById('stage'), modal=document.getElementById('exportModal');
      
      let ocanvas=document.createElement('canvas'), octx=ocanvas.getContext('2d');
      let scale=1, lastOut=null;

      fileInp.onchange = e => {
        const img = new Image();
        img.onload = () => {
          ocanvas.width=img.width; ocanvas.height=img.height;
          octx.drawImage(img,0,0);
          canvas.width=img.width; canvas.height=img.height;
          scale = Math.min(stage.clientWidth/img.width, stage.clientHeight/img.height, 0.8);
          process();
        };
        img.src = URL.createObjectURL(e.target.files[0]);
      };

      function process(){
        if(!ocanvas.width) return;
        let target = hexToRgb(colorInp.value);
        if(mode.value==='white') target=[255,255,255];
        if(mode.value==='black') target=[0,0,0];
        
        const threshold = (+fuzz.value) * 2.5;
        const imgData = octx.getImageData(0,0,ocanvas.width,ocanvas.height), d = imgData.data;
        const out = ctx.createImageData(ocanvas.width,ocanvas.height), o = out.data;

        for(let i=0; i<d.length; i+=4){
          const dist = Math.sqrt((d[i]-target[0])**2 + (d[i+1]-target[1])**2 + (d[i+2]-target[2])**2);
          o[i]=d[i]; o[i+1]=d[i+1]; o[i+2]=d[i+2];
          o[i+3] = dist < threshold ? 0 : d[i+3];
        }
        lastOut=out; render();
      }

      function render(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(lastOut) ctx.putImageData(lastOut,0,0);
        canvas.style.transform=`scale(${scale})`;
      }

      canvas.onclick = e => {
        if(mode.value !== 'pick') return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left)/scale, y = (e.clientY - rect.top)/scale;
        const p = octx.getImageData(x,y,1,1).data;
        colorInp.value = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
        process();
      };

      document.getElementById('btnOpenExport').onclick = () => {
        if(!ocanvas.width) return;
        modal.classList.remove('hidden');
        document.getElementById('exW').value = ocanvas.width;
        document.getElementById('exH').value = ocanvas.height;
      };

      document.getElementById('btnFinalSave').onclick = () => {
        if(!isVip) {
          window.open("https://wa.me/51916689969?text=Hola,%20soy%20de%20J&J%20Studio%20y%20quiero%20activar%20mi%20descarga%20VIP", "_blank");
          return;
        }
        const a = document.createElement('a');
        a.download = 'jj_studio_pro.png';
        a.href = canvas.toDataURL();
        a.click();
      };

      // --- COLOR PICKER LIENZO PRO ---
      const cpSV=document.getElementById('cpSV'), cpH=document.getElementById('cpH'), svCtx=cpSV.getContext('2d'), hCtx=cpH.getContext('2d');
      let hue=0;

      function drawCP(){
        // Barra Hue
        const gH=hCtx.createLinearGradient(0,0,0,120);
        for(let i=0;i<=360;i+=10) gH.addColorStop(i/360, `hsl(${i},100%,50%)`);
        hCtx.fillStyle=gH; hCtx.fillRect(0,0,20,120);

        // Recuadro Sat/Val
        svCtx.fillStyle=`hsl(${hue},100%,50%)`; svCtx.fillRect(0,0,220,120);
        const gW=svCtx.createLinearGradient(0,0,220,0); gW.addColorStop(0,'#fff'); gW.addColorStop(1,'transparent');
        svCtx.fillStyle=gW; svCtx.fillRect(0,0,220,120);
        const gB=svCtx.createLinearGradient(0,0,0,120); gB.addColorStop(0,'transparent'); gB.addColorStop(1,'#000');
        svCtx.fillStyle=gB; svCtx.fillRect(0,0,220,120);
      }

      cpH.onmousedown = e => {
        const move = ev => {
          const r=cpH.getBoundingClientRect();
          hue = ((ev.clientY-r.top)/120)*360; drawCP();
        };
        window.onmousemove=move; window.onmouseup=()=>window.onmousemove=null; move(e);
      };

      cpSV.onmousedown = e => {
        const move = ev => {
          const r=cpSV.getBoundingClientRect();
          const x=ev.clientX-r.left, y=ev.clientY-r.top;
          const p = svCtx.getImageData(x,y,1,1).data;
          stage.style.background = `rgb(${p[0]},${p[1]},${p[2]})`;
        };
        window.onmousemove=move; window.onmouseup=()=>window.onmousemove=null; move(e);
      };

      drawCP();
      function hexToRgb(h){const v=h.replace('#',''); return [parseInt(v.slice(0,2),16),parseInt(v.slice(2,4),16),parseInt(v.slice(4,6),16)];}
      [mode, colorInp, fuzz].forEach(el => el.oninput = process);
      stage.onwheel = e => { e.preventDefault(); scale *= e.deltaY > 0 ? 0.9 : 1.1; render(); };
      document.getElementById('reset').onclick = () => location.reload();
    })();
  </script>
</body>
</html>
