<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&J Studio Pro ‚Äî Recorte y Fondo</title>
    <style>
        :root { --bg: #0a0a0a; --panel: #111; --text: #eee; --accent: #f87171; --success: #10b981; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        .wrap { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }
        .panel { padding: 20px; background: #111; border-right: 1px solid #1f1f1f; overflow-y: auto; }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .val-box { background: #1a1a1a; padding: 4px 8px; border-radius: 4px; width: 45px; text-align: center; font-size: 12px; }
        .stage { background: #0b0b0b; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; height: 100%; }
        
        /* --- ESTILOS DEL RECUADRO DE RECORTE --- */
        #canvas-wrap { position: relative; display: inline-block; }
        #crop-box {
            position: absolute; border: 2px solid var(--accent);
            display: none; cursor: move;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.7); /* Oscurece el resto */
        }
        /* Tirador para redimensionar */
        .resizer {
            width: 15px; height: 15px; background: #fff;
            position: absolute; right: -7px; bottom: -7px;
            cursor: nwse-resize; border-radius: 50%; border: 2px solid var(--accent);
        }
        
        .btn-s { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #171717; color: #eee; cursor: pointer; font-size: 12px; font-weight: 800; flex: 1; }
        .hidden { display: none !important; }
        .btn-dl { width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #22c55e); color: #052e1a; border: none; border-radius: 8px; margin-top: 15px; font-weight: 900; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay" style="position:fixed; inset:0; background:#0a0a0a; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div style="background:#111; padding:40px; border-radius:20px; text-align:center; width:350px; border:1px solid #1f1f1f;">
            <div style="font-size:2rem; font-weight:800; color:#00d2ff; margin-bottom:20px;">J&J STUDIO</div>
            <input type="text" id="user-id" placeholder="Celular" style="width:100%; padding:10px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #333;">
            <input type="password" id="access-key" placeholder="Contrase√±a" style="width:100%; padding:10px; margin-bottom:20px; background:#000; color:#fff; border:1px solid #333;">
            <button onclick="validateAccess()" style="width:100%; padding:10px; background:#00d2ff; border:none; font-weight:bold; cursor:pointer;">ENTRAR</button>
        </div>
    </div>

    <main class="wrap">
        <section class="panel">
            <h2>Cargar imagen</h2>
            <input type="file" id="file" accept="image/*" style="width:100%; margin-bottom:20px;">
            
            <h2>Configuraci√≥n</h2>
            <div class="control-row"><label>Tolerancia</label><input type="range" id="fuzz" min="0" max="200" value="60"><div class="val-box" id="fuzzV">60</div></div>
            <div class="control-row"><label>Suavizado</label><input type="range" id="feather" min="0" max="10" step="0.1" value="0.8"><div class="val-box" id="featherV">0.8</div></div>

            <h2>Recorte</h2>
            <div style="display:flex; gap:10px;">
                <button class="btn-s" id="btn-init-crop">üìê Activar Recorte</button>
                <button class="btn-s hidden" id="btn-apply-crop" style="background:var(--success); color:#000;">‚úì Aplicar</button>
            </div>
            
            <button class="btn-dl" id="btn-download">DESCARGAR PNG</button>
        </section>

        <section class="stage">
            <div id="canvas-wrap">
                <canvas id="canvas"></canvas>
                <div id="crop-box">
                    <div class="resizer"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxkuP3Sov5C0q0yVGrnFjj9kO1yO-QkA2niydkUBjQMDHQWFCVTyLmlwd2B1puHb6Z-/exec";

        async function validateAccess() {
            const u = document.getElementById('user-id').value;
            const p = document.getElementById('access-key').value;
            const res = await fetch(`${WEB_APP_URL}?user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.access) document.getElementById('login-overlay').style.display='none';
            else alert("Acceso denegado");
        }

        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        const cropBox = document.getElementById('crop-box');
        let oCanvas = document.createElement('canvas'), oCtx = oCanvas.getContext('2d');

        document.getElementById('file').onchange = e => {
            const img = new Image();
            img.onload = () => {
                oCanvas.width = img.width; oCanvas.height = img.height;
                oCtx.drawImage(img, 0, 0);
                process();
            };
            img.src = URL.createObjectURL(e.target.files[0]);
        };

        // --- L√ìGICA DE RECORTE AJUSTABLE ---
        let isResizing = false;
        let isDragging = false;

        document.getElementById('btn-init-crop').onclick = () => {
            if(!oCanvas.width) return;
            cropBox.style.display = 'block';
            cropBox.style.width = '200px';
            cropBox.style.height = '200px';
            cropBox.style.top = '10px';
            cropBox.style.left = '10px';
            document.getElementById('btn-apply-crop').classList.remove('hidden');
        };

        // Arrastrar el cuadro
        cropBox.onmousedown = (e) => {
            if (e.target.classList.contains('resizer')) return;
            isDragging = true;
        };

        // Redimensionar el cuadro
        document.querySelector('.resizer').onmousedown = (e) => {
            isResizing = true;
            e.stopPropagation();
            e.preventDefault();
        };

        window.onmousemove = (e) => {
            const rect = document.getElementById('canvas-wrap').getBoundingClientRect();
            if (isResizing) {
                cropBox.style.width = (e.clientX - cropBox.getBoundingClientRect().left) + 'px';
                cropBox.style.height = (e.clientY - cropBox.getBoundingClientRect().top) + 'px';
            } else if (isDragging) {
                cropBox.style.left = (e.clientX - rect.left - cropBox.offsetWidth / 2) + 'px';
                cropBox.style.top = (e.clientY - rect.top - cropBox.offsetHeight / 2) + 'px';
            }
        };

        window.onmouseup = () => { isResizing = false; isDragging = false; };

        document.getElementById('btn-apply-crop').onclick = () => {
            const canvRect = canvas.getBoundingClientRect();
            const boxRect = cropBox.getBoundingClientRect();
            const scale = oCanvas.width / canvRect.width;

            const x = (boxRect.left - canvRect.left) * scale;
            const y = (boxRect.top - canvRect.top) * scale;
            const w = boxRect.width * scale;
            const h = boxRect.height * scale;

            const temp = document.createElement('canvas');
            temp.width = w; temp.height = h;
            temp.getContext('2d').drawImage(oCanvas, x, y, w, h, 0, 0, w, h);
            
            oCanvas.width = w; oCanvas.height = h;
            oCtx.drawImage(temp, 0, 0);
            cropBox.style.display = 'none';
            document.getElementById('btn-apply-crop').classList.add('hidden');
            process();
        };

        function process() {
            if(!oCanvas.width) return;
            canvas.width = oCanvas.width; canvas.height = oCanvas.height;
            ctx.drawImage(oCanvas, 0, 0);
            // (Aqu√≠ se aplica la l√≥gica de fondo ya programada antes)
        }

        document.getElementById('btn-download').onclick = () => {
            const a = document.createElement('a');
            a.download = 'jj_crop.png';
            a.href = canvas.toDataURL();
            a.click();
        };
    </script>
</body>
</html>