<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>J&J Studio — Quitar Fondo Pro</title>
  <style>
    :root {
      --bg:#0a0a0a; --panel:#111; --text:#eeeeee; --muted:#9ca3af;
      --accent:#6366f1; --accent-2:#0ea5e9; --border:#1f1f1f;
      --success-1:#10b981; --success-2:#22c55e; --vip:#00d2ff;
      --overlay:rgba(0,0,0,.85);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
    
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#0b0b0b;position:sticky;top:0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:800;letter-spacing:.5px;color:var(--vip)}
    #status-tag { font-size: 10px; padding: 4px 10px; border-radius: 20px; background: #1a2030; color: #64748b; font-weight: bold; }

    .wrap{display:grid;grid-template-columns:350px 1fr;gap:16px;height:calc(100vh - 58px);padding:16px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr; overflow-y: auto;}}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow-y:auto;padding:15px}
    .panel h2{font-size:12px;font-weight:700;margin:15px 0 8px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid #222;padding-bottom:4px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0}
    label{font-size:12px;color:#e5e7eb}
    
    select, input[type="number"], .btn-s{background:#1a1a1a;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px}
    input[type="range"]{width:100%; accent-color: var(--accent);}
    
    .canvasWrap{position:relative;padding:10px;background:#0b0b0b;border:1px solid var(--border);border-radius:12px;height:100%;display:flex;flex-direction:column}
    .stage{position:relative;overflow:hidden;border-radius:10px;flex-grow:1;background:#0f0f0f;display:flex;align-items:center;justify-content:center}
    canvas#canvas{max-width:100%; max-height:100%; object-fit:contain;}

    .btn-download{
      width:100%; background: linear-gradient(135deg, var(--success-1), var(--success-2));
      border:none;color:#052e1a;padding:14px;border-radius:8px;cursor:pointer;font-weight:900;margin-top:10px;
    }
    .btn-vip{background:var(--vip); color:#000; border:none; padding:10px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-bottom:10px;}

    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{width:450px;background:#121212;border:1px solid #262626;border-radius:14px;padding:20px;text-align:center}
    .hidden{display:none!important}
    .m-input{width:100%; padding:10px; background:#000; border:1px solid #333; color:#fff; border-radius:8px; margin-bottom:10px}
  </style>
</head>
<body>

  <header>
    <h1>J&J STUDIO PRO <small style="color:#555; font-size:10px">Advanced Background Removal</small></h1>
    <div id="status-tag">MODO INVITADO</div>
  </header>

  <main class="wrap">
    <section class="panel">
      <button class="btn-vip" onclick="location.href='simulador.html'">✨ IR AL SIMULADOR MOCKUP</button>
      
      <h2>1. Cargar imagen</h2>
      <input id="file" type="file" accept="image/*">

      <h2>2. Limpieza Técnica</h2>
      <div class="row">
        <label>Modo</label>
        <select id="mode" onchange="process()">
          <option value="white">Fondo Blanco</option>
          <option value="black">Fondo Negro</option>
          <option value="pick">Cuentagotas (Clic imagen)</option>
        </select>
      </div>

      <div class="row"><label>Tolerancia</label><input id="fuzz" type="range" min="0" max="200" value="60" oninput="process()"></div>
      <div class="row"><label>Suavizado (px)</label><input id="feather" type="range" min="0" max="10" step="0.5" value="0" oninput="process()"></div>
      <div class="row"><label>Contraer / Exp (px)</label><input id="contract" type="range" min="-10" max="10" step="1" value="0" oninput="process()"></div>

      <button id="download" class="btn-download">DESCARGAR RESULTADO</button>
      <button onclick="location.reload()" style="background:none; border:none; color:#444; width:100%; margin-top:15px; cursor:pointer; font-size:11px;">Cerrar Sesión / Reiniciar</button>
    </section>

    <section class="canvasWrap">
      <div class="stage" id="stage">
        <canvas id="canvas"></canvas>
      </div>
    </section>
  </main>

  <div id="resizeModal" class="modal-backdrop hidden">
    <div class="modal">
      <h3 style="color:var(--vip)">Exportar — Redimensionar</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:left; margin:20px 0">
        <div><label>Ancho (px)</label><input id="rzW" type="number" class="m-input"></div>
        <div><label>Alto (px)</label><input id="rzH" type="number" class="m-input"></div>
        <div style="grid-column: span 2">
            <label>Método de remuestreo</label>
            <select id="rzMethod" class="m-input">
                <option value="high">Bicúbica (Mejor calidad)</option>
                <option value="medium">Bilinear (Estándar)</option>
                <option value="low">Nearest (Pixelado)</option>
            </select>
        </div>
      </div>
      <button class="btn-download" onclick="validateOrAction()">APLICAR Y DESCARGAR</button>
      <button onclick="closeModal()" style="background:none; border:none; color:#666; cursor:pointer; margin-top:10px">Cancelar</button>
    </div>
  </div>

  <div id="loginModal" class="modal-backdrop hidden">
      <div class="modal" style="max-width:350px">
          <h3>Socio VIP J&J</h3>
          <input type="text" id="user-id" class="m-input" placeholder="Celular">
          <input type="password" id="access-key" class="m-input" placeholder="Contraseña">
          <button class="btn-download" onclick="doLogin()">ENTRAR</button>
      </div>
  </div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxkuP3Sov5C0q0yVGrnFjj9kO1yO-QkA2niydkUBjQMDHQWFCVTyLmlwd2B1puHb6Z-/exec";
  const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
  let oCanvas = document.createElement('canvas'), oCtx = oCanvas.getContext('2d');
  let isVip = false;
  let targetColor = [255,255,255];

  document.getElementById('file').onchange = e => {
    const img = new Image();
    img.onload = () => {
      oCanvas.width = img.width; oCanvas.height = img.height;
      oCtx.drawImage(img, 0, 0);
      process();
    };
    img.src = URL.createObjectURL(e.target.files[0]);
  };

  function process() {
    if(!oCanvas.width) return;
    const fuzz = parseInt(document.getElementById('fuzz').value);
    const soft = parseFloat(document.getElementById('feather').value);
    const cont = parseFloat(document.getElementById('contract').value);
    const mode = document.getElementById('mode').value;

    if(mode === 'white') targetColor = [255,255,255];
    else if(mode === 'black') targetColor = [0,0,0];

    const id = oCtx.getImageData(0,0,oCanvas.width,oCanvas.height), d = id.data;
    const out = ctx.createImageData(oCanvas.width,oCanvas.height), o = out.data;
    const thr = fuzz * 2.1;

    for(let i=0; i<d.length; i+=4) {
      const dist = Math.sqrt((d[i]-targetColor[0])**2 + (d[i+1]-targetColor[1])**2 + (d[i+2]-targetColor[2])**2);
      o[i]=d[i]; o[i+1]=d[i+1]; o[i+2]=d[i+2];
      o[i+3] = (dist < thr) ? 0 : d[i+3];
    }

    canvas.width = oCanvas.width; canvas.height = oCanvas.height;
    ctx.putImageData(out, 0, 0);

    // MOTOR DE PÍXELES MEJORADO (Urban Style)
    if(cont !== 0 || soft > 0) {
        let temp = document.createElement('canvas');
        temp.width = canvas.width; temp.height = canvas.height;
        let tCtx = temp.getContext('2d');
        
        // Operación de Contraer/Expandir real usando desenfoque inverso
        if(cont !== 0) {
            tCtx.globalCompositeOperation = 'source-over';
            tCtx.filter = `blur(${Math.abs(cont)}px)`;
            tCtx.drawImage(canvas, 0, 0);
            
            ctx.globalCompositeOperation = cont > 0 ? 'destination-in' : 'source-over';
            ctx.drawImage(temp, 0, 0);
            ctx.globalCompositeOperation = 'source-over';
        }

        // Suavizado final de bordes (Feather)
        if(soft > 0) {
            ctx.filter = `blur(${soft}px)`;
            tCtx.clearRect(0,0,temp.width,temp.height);
            tCtx.drawImage(canvas, 0, 0);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.filter = 'none';
            ctx.drawImage(temp, 0, 0);
        }
    }
  }

  // Lógica de Descarga y Modal
  document.getElementById('download').onclick = () => {
    if(!oCanvas.width) return;
    document.getElementById('rzW').value = oCanvas.width;
    document.getElementById('rzH').value = oCanvas.height;
    document.getElementById('resizeModal').classList.remove('hidden');
  };

  function validateOrAction() {
    if(!isVip) {
      document.getElementById('resizeModal').classList.add('hidden');
      document.getElementById('loginModal').classList.remove('hidden');
    } else {
      executeDownload();
    }
  }

  async function doLogin() {
    const u = document.getElementById('user-id').value;
    const p = document.getElementById('access-key').value;
    const res = await fetch(`${WEB_APP_URL}?user=${u}&pass=${p}`);
    const data = await res.json();
    if(data.access) {
      isVip = true;
      document.getElementById('status-tag').innerText = "SOCIO VIP ACTIVO";
      document.getElementById('status-tag').style.color = "#10b981";
      document.getElementById('loginModal').classList.add('hidden');
      alert("¡Acceso concedido!");
    } else { alert("Datos incorrectos"); }
  }

  function executeDownload() {
    const finalW = parseInt(document.getElementById('rzW').value);
    const finalH = parseInt(document.getElementById('rzH').value);
    const method = document.getElementById('rzMethod').value;
    
    let finalCanvas = document.createElement('canvas');
    finalCanvas.width = finalW; finalCanvas.height = finalH;
    let fCtx = finalCanvas.getContext('2d');
    
    if(method === 'high') fCtx.imageSmoothingQuality = 'high';
    else if(method === 'low') fCtx.imageSmoothingEnabled = false;

    fCtx.drawImage(canvas, 0, 0, finalW, finalH);
    const a = document.createElement('a');
    a.download = `jj_studio_pro_${finalW}px.png`;
    a.href = finalCanvas.toDataURL();
    a.click();
    closeModal();
  }

  function closeModal() { document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.add('hidden')); }

  // Cuentagotas
  canvas.onclick = (e) => {
    if(document.getElementById('mode').value !== 'pick') return;
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (oCanvas.width / r.width);
    const y = (e.clientY - r.top) * (oCanvas.height / r.height);
    const p = oCtx.getImageData(x, y, 1, 1).data;
    targetColor = [p[0], p[1], p[2]]; process();
  };
</script>
</body>
</html>
