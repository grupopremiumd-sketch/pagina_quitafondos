<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>J&J STUDIO PRO â€” Quitar Fondo Ã‰lite</title>
    <style>
        :root {
            --bg:#0a0a0a; --panel:#111; --text:#eeeeee; --muted:#9ca3af;
            --accent:#6366f1; --accent-2:#0ea5e9; --border:#1f1f1f;
            --success-1:#10b981; --success-2:#22c55e; --vip:#00d2ff;
            --overlay:rgba(0,0,0,.85);
        }
        * { box-sizing:border-box }
        body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--text); overflow:hidden; }
        
        header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:#0b0b0b; position:sticky; top:0; z-index:10 }
        header h1 { font-size:15px; margin:0; font-weight:800; color:var(--vip) }
        #status-tag { font-size:10px; padding:4px 10px; border-radius:20px; background:#1a2030; color:#64748b; font-weight:bold; }

        .wrap { display:grid; grid-template-columns:350px 1fr; gap:16px; height:calc(100vh - 58px); padding:16px }
        @media(max-width:900px) { .wrap { grid-template-columns:1fr; overflow-y:auto; } }

        .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow-y:auto; padding:15px }
        .panel h2 { font-size:12px; font-weight:700; margin:15px 0 8px; color:var(--muted); text-transform:uppercase; border-bottom:1px solid #222; padding-bottom:4px }
        .row { display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin:10px 0 }
        label { font-size:12px; color:#e5e7eb }
        
        select, input[type="number"], .btn-s { background:#1a1a1a; border:1px solid var(--border); color:var(--text); border-radius:8px; padding:8px }
        input[type="range"] { width:100%; accent-color: var(--accent); }
        .val-box { background:#000; color:var(--vip); padding:3px 6px; border-radius:4px; font-size:11px; width:55px; text-align:center; font-weight:bold; }

        .stage { background:#0b0b0b; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; border-radius:10px; border:1px solid var(--border); }
        canvas#canvas { max-width:95%; max-height:95%; object-fit:contain; image-rendering: -webkit-optimize-contrast; }

        .btn-download {
            width:100%; background: linear-gradient(135deg, var(--success-1), var(--success-2));
            border:none; color:#052e1a; padding:15px; border-radius:8px; cursor:pointer; font-weight:900; margin-top:15px;
        }
        .btn-nav { background:var(--vip); color:#000; border:none; padding:10px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-bottom:10px; }

        /* Modales */
        .modal-backdrop { position:fixed; inset:0; background:var(--overlay); display:flex; align-items:center; justify-content:center; z-index:1000 }
        .modal { width:420px; background:#121212; border:1px solid #262626; border-radius:18px; padding:25px; text-align:center }
        .hidden { display:none!important }
        .m-input { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:8px; margin-bottom:10px }
        
        .choice-card { background:#1a1a1a; border:1px solid #333; padding:15px; border-radius:12px; cursor:pointer; margin-bottom:10px; display:flex; align-items:center; gap:15px; text-align:left; }
        .choice-card:hover { border-color: var(--vip); }
    </style>
</head>
<body>

    <div id="choice-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h3 style="color:var(--vip); margin-top:0">Â¡DiseÃ±o Listo!</h3>
            <p style="color:var(--muted); font-size:13px; margin-bottom:20px;">La descarga en alta resoluciÃ³n es exclusiva para socios J&J.</p>
            <div class="choice-card" onclick="openLogin()">
                <div style="font-size:24px;">ðŸ’Ž</div>
                <div><div style="font-weight:bold; color:white;">Ya soy Socio VIP</div><div style="font-size:11px; color:var(--muted)">Inicia sesiÃ³n para descargar.</div></div>
            </div>
            <div class="choice-card" onclick="window.open('https://wa.me/51916689969')">
                <div style="font-size:24px;">ðŸ“²</div>
                <div><div style="font-weight:bold; color:#25d366;">No tengo suscripciÃ³n</div><div style="font-size:11px; color:var(--muted)">Adquiere tu acceso por WhatsApp.</div></div>
            </div>
            <button onclick="closeChoice()" style="background:none; border:none; color:#555; cursor:pointer; margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <div id="login-modal" class="modal-backdrop hidden">
        <div class="modal" style="max-width:350px;">
            <h3>Validar MembresÃ­a</h3>
            <input type="text" id="user-id" class="m-input" placeholder="ðŸ“± NÃºmero de Celular">
            <input type="password" id="access-key" class="m-input" placeholder="ðŸ”‘ ContraseÃ±a">
            <button class="btn-download" onclick="validateAccess()" style="margin:0;">VERIFICAR Y DESCARGAR</button>
            <button onclick="closeLogin()" style="background:none; border:none; color:var(--muted); margin-top:15px; cursor:pointer;">Regresar</button>
        </div>
    </div>

    <header>
        <h1>J&J STUDIO PRO</h1>
        <div id="status-tag">MODO INVITADO</div>
    </header>

    <main class="wrap">
        <aside class="panel">
            <button class="btn-nav" onclick="location.href='simulador.html'">âœ¨ IR AL SIMULADOR MOCKUP</button>
            
            <h2>1. CARGAR IMAGEN</h2>
            <input id="file" type="file" accept="image/*">

            <h2>2. LIMPIEZA TÃ‰CNICA (PX)</h2>
            <div class="row">
                <label>Modo</label>
                <select id="mode" onchange="process()">
                    <option value="white">Quitar Blanco</option>
                    <option value="black">Quitar Negro</option>
                    <option value="pick">Cuentagotas (Clic imagen)</option>
                </select>
            </div>
            <div class="row"><label>Tolerancia</label><input id="fuzz" type="range" min="0" max="150" value="60" oninput="process()"><div class="val-box" id="fV">60</div></div>
            <div class="row"><label>Contraer (px)</label><input id="contract" type="range" min="0" max="10" step="1" value="0" oninput="process()"><div class="val-box" id="cV">0 px</div></div>
            <div class="row"><label>Suavizado (px)</label><input id="feather" type="range" min="0" max="15" step="1" value="0" oninput="process()"><div class="val-box" id="sV">0 px</div></div>

            <button id="btnMainDownload" class="btn-download" onclick="handleDownloadRequest()">DESCARGAR PNG</button>
            <button onclick="location.reload()" style="background:none; border:none; color:#444; width:100%; margin-top:15px; cursor:pointer; font-size:11px;">Cerrar SesiÃ³n / Reiniciar</button>
        </aside>

        <section class="stage">
            <canvas id="canvas"></canvas>
        </section>
    </main>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxkuP3Sov5C0q0yVGrnFjj9kO1yO-QkA2niydkUBjQMDHQWFCVTyLmlwd2B1puHb6Z-/exec";
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    let oCanvas = document.createElement('canvas'), oCtx = oCanvas.getContext('2d');
    let isVip = false;
    let targetColor = [255,255,255];

    document.getElementById('file').onchange = e => {
        const img = new Image();
        img.onload = () => { oCanvas.width = img.width; oCanvas.height = img.height; oCtx.drawImage(img,0,0); process(); };
        img.src = URL.createObjectURL(e.target.files[0]);
    };

    function process() {
        if(!oCanvas.width) return;
        const fuzz = parseInt(document.getElementById('fuzz').value);
        const cont = parseInt(document.getElementById('contract').value);
        const soft = parseInt(document.getElementById('feather').value);
        
        document.getElementById('fV').innerText = fuzz;
        document.getElementById('cV').innerText = cont + " px";
        document.getElementById('sV').innerText = soft + " px";

        if(document.getElementById('mode').value === 'white') targetColor = [255,255,255];
        else if(document.getElementById('mode').value === 'black') targetColor = [0,0,0];

        const id = oCtx.getImageData(0,0,oCanvas.width,oCanvas.height), d = id.data;
        const out = ctx.createImageData(oCanvas.width,oCanvas.height), o = out.data;
        const thr = fuzz * 2.2;

        for(let i=0; i<d.length; i+=4) {
            const diff = Math.sqrt((d[i]-targetColor[0])**2 + (d[i+1]-targetColor[1])**2 + (d[i+2]-targetColor[2])**2);
            o[i]=d[i]; o[i+1]=d[i+1]; o[i+2]=d[i+2];
            o[i+3] = (diff < thr) ? 0 : d[i+3];
        }

        canvas.width = oCanvas.width; canvas.height = oCanvas.height;
        ctx.putImageData(out, 0, 0);

        // MOTOR DE PÃXELES (Urban Style)
        if (cont > 0 || soft > 0) {
            const temp = document.createElement('canvas');
            temp.width = canvas.width; temp.height = canvas.height;
            const tCtx = temp.getContext('2d');
            
            if (cont > 0) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.filter = `blur(${cont}px)`;
                ctx.drawImage(canvas, 0, 0);
                ctx.globalCompositeOperation = 'source-over';
                ctx.filter = 'none';
            }
            if (soft > 0) {
                tCtx.filter = `blur(${soft/2}px)`;
                tCtx.drawImage(canvas, 0, 0);
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(temp, 0, 0);
                ctx.filter = 'none';
            }
        }
    }

    // --- MembresÃ­a y Descarga ---
    function handleDownloadRequest() {
        if(!oCanvas.width) return;
        if(isVip) { triggerDownload(); } 
        else { document.getElementById('choice-modal').classList.remove('hidden'); }
    }

    function openLogin() { closeChoice(); document.getElementById('login-modal').classList.remove('hidden'); }
    function closeChoice() { document.getElementById('choice-modal').classList.add('hidden'); }
    function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }

    async function validateAccess() {
        const u = document.getElementById('user-id').value, p = document.getElementById('access-key').value;
        if(!u || !p) return;
        try {
            const res = await fetch(`${WEB_APP_URL}?user=${u}&pass=${p}`);
            const data = await res.json();
            if(data.access) {
                isVip = true;
                document.getElementById('status-tag').innerText = "SOCIO VIP ACTIVO";
                document.getElementById('status-tag').style.color = "#10b981";
                closeLogin();
                triggerDownload();
            } else { alert("MembresÃ­a no encontrada."); }
        } catch(e) { alert("Error de conexiÃ³n"); }
    }

    function triggerDownload() {
        const a = document.createElement('a');
        a.download = 'jj_studio_pro.png';
        a.href = canvas.toDataURL();
        a.click();
    }

    // Cuentagotas
    canvas.onclick = (e) => {
        if(document.getElementById('mode').value !== 'pick') return;
        const r = canvas.getBoundingClientRect();
        const x = (e.clientX - r.left) * (oCanvas.width / r.width);
        const y = (e.clientY - r.top) * (oCanvas.height / r.height);
        const p = oCtx.getImageData(x, y, 1, 1).data;
        targetColor = [p[0], p[1], p[2]]; process();
    };
</script>
</body>
</html>
