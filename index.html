<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>J&J Studio Pro — Quitafondos</title>
    <style>
        :root {
            --bg: #0a0a0a; --panel: #111; --text: #eee; --muted: #9ca3af;
            --accent: #6366f1; --border: #1f1f1f; --vip: #00d2ff;
            --success-1: #10b981; --success-2: #22c55e;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; background: #0b0b0b; position: sticky; top: 0; z-index: 10; }
        header h1 { font-size: 15px; margin: 0; font-weight: 900; color: var(--vip); letter-spacing: .5px; }

        .wrap { display: grid; grid-template-columns: 350px 1fr; gap: 16px; height: calc(100vh - 58px); padding: 16px; }
        @media(max-width:900px) { .wrap { grid-template-columns: 1fr; overflow-y: auto; } }

        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .panel h2 { font-size: 13px; font-weight: 800; margin: 10px 0 5px; color: var(--muted); text-transform: uppercase; }
        
        .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 5px 0; }
        input, select, button { background: #1a1a1a; border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 8px; outline: none; }
        input[type="range"] { width: 100%; accent-color: var(--vip); }
        
        .btn-nav { background: #222; color: var(--vip); border: 1px solid var(--vip); cursor: pointer; font-weight: 800; width: 100%; }
        .btn-download { background: linear-gradient(135deg, var(--success-1), var(--success-2)); border: none; color: #052e1a; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 900; margin-top: 10px; }

        .canvasWrap { position: relative; background: #0b0b0b; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas#canvas { display: block; transform-origin: top left; cursor: crosshair; }

        .cp-wrap { display: flex; gap: 10px; margin-top: 5px; }
        #cpSV { border-radius: 6px; border: 1px solid #2a2a2a; cursor: crosshair; }
        #cpH { border-radius: 6px; border: 1px solid #2a2a2a; cursor: ns-resize; }

        /* Modal Resize */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { width: min(450px, 90vw); background: #121212; border: 1px solid #262626; border-radius: 14px; padding: 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header><h1>J&J STUDIO PRO — QUITAFONDOS</h1></header>

    <main class="wrap">
        <aside class="panel">
            <button class="btn-nav" onclick="location.href='simulador.html'">✨ IR AL SIMULADOR</button>
            
            <h2>1. Cargar imagen</h2>
            <input id="file" type="file" accept="image/*">

            <h2>2. Configuración</h2>
            <div class="row">
                <label>Modo</label>
                <select id="mode">
                    <option value="white">Quitar blanco</option>
                    <option value="black">Quitar negro</option>
                    <option value="pick">Elegir color (clic en imagen)</option>
                </select>
                <input id="targetColor" type="color" value="#ffffff">
            </div>
            <div class="row"><label>Tolerancia</label><input id="fuzz" type="range" min="0" max="200" value="60"></div>
            
            <h2>3. Color del lienzo</h2>
            <div class="cp-wrap">
                <canvas id="cpSV" width="200" height="100"></canvas>
                <canvas id="cpH" width="20" height="100"></canvas>
            </div>

            <button id="reset" style="margin-top:15px; background: transparent;">Reiniciar</button>
            <button id="openExport" class="btn-download">DESCARGAR PNG</button>
        </aside>

        <section class="canvasWrap" id="stage">
            <canvas id="canvas"></canvas>
        </section>
    </main>

    <div id="exportModal" class="modal-backdrop hidden">
        <div class="modal">
            <h3 style="margin-top:0">Opciones de Exportación</h3>
            <div class="row"><label>Ancho (px)</label><input id="exW" type="number"></div>
            <div class="row"><label>Alto (px)</label><input id="exH" type="number"></div>
            <div class="row"><label>DPI / Calidad</label><input id="exDPI" type="number" value="300"></div>
            <div style="display:flex; gap:10px; margin-top:20px; justify-content: flex-end;">
                <button onclick="document.getElementById('exportModal').classList.add('hidden')">Cancelar</button>
                <button id="btnFinalDownload" style="background:var(--vip); color:#000; border:none; padding:8px 20px;">GUARDAR</button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const fileInp = document.getElementById('file'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
            const mode = document.getElementById('mode'), tColor = document.getElementById('targetColor'), fuzz = document.getElementById('fuzz');
            const stage = document.getElementById('stage'), exModal = document.getElementById('exportModal');

            let oCanvas = document.createElement('canvas'), oCtx = oCanvas.getContext('2d');
            let scale = 1, lastOut = null;

            fileInp.onchange = e => {
                const img = new Image();
                img.onload = () => {
                    oCanvas.width = img.width; oCanvas.height = img.height;
                    oCtx.drawImage(img, 0, 0);
                    canvas.width = img.width; canvas.height = img.height;
                    scale = Math.min(stage.clientWidth/img.width, stage.clientHeight/img.height, 0.8);
                    process();
                };
                img.src = URL.createObjectURL(e.target.files[0]);
            };

            // Función para elegir color haciendo clic en la imagen
            canvas.onclick = e => {
                if(mode.value !== 'pick') return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / scale;
                const y = (e.clientY - rect.top) / scale;
                const p = oCtx.getImageData(x, y, 1, 1).data;
                tColor.value = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
                process();
            };

            function process() {
                if(!oCanvas.width) return;
                let target = hexToRgb(tColor.value);
                if(mode.value === 'white') target = [255, 255, 255];
                if(mode.value === 'black') target = [0, 0, 0];

                const threshold = (+fuzz.value) * 2.5;
                const imgData = oCtx.getImageData(0,0,oCanvas.width,oCanvas.height), d = imgData.data;
                const out = ctx.createImageData(oCanvas.width,oCanvas.height), o = out.data;

                for(let i=0; i<d.length; i+=4) {
                    const dist = Math.sqrt((d[i]-target[0])**2 + (d[i+1]-target[1])**2 + (d[i+2]-target[2])**2);
                    o[i]=d[i]; o[i+1]=d[i+1]; o[i+2]=d[i+2];
                    o[i+3] = dist < threshold ? 0 : d[i+3];
                }
                lastOut = out; render();
            }

            function render() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                if(lastOut) ctx.putImageData(lastOut, 0, 0);
                canvas.style.transform = `scale(${scale})`;
            }

            function hexToRgb(h) {
                let v = h.replace('#','');
                return [parseInt(v.slice(0,2),16), parseInt(v.slice(2,4),16), parseInt(v.slice(4,6),16)];
            }

            // Selector de color del lienzo (Fondo)
            const cpH = document.getElementById('cpH');
            function drawH(){
                const g = cpH.getContext('2d');
                const grd = g.createLinearGradient(0,0,0,100);
                for(let i=0;i<=360;i+=10) grd.addColorStop(i/360, `hsl(${i},100%,50%)`);
                g.fillStyle=grd; g.fillRect(0,0,20,100);
            }
            drawH();
            cpH.onmousedown = e => {
                const r = cpH.getBoundingClientRect();
                const h = ((e.clientY - r.top)/100)*360;
                stage.style.background = `hsl(${h}, 40%, 15%)`;
            };

            // Modal Exportar
            document.getElementById('openExport').onclick = () => {
                if(!oCanvas.width) return;
                exModal.classList.remove('hidden');
                document.getElementById('exW').value = oCanvas.width;
                document.getElementById('exH').value = oCanvas.height;
            };

            document.getElementById('btnFinalDownload').onclick = () => {
                const a = document.createElement('a');
                a.download = 'jj_studio_pro.png';
                a.href = canvas.toDataURL();
                a.click();
                exModal.classList.add('hidden');
            };

            [mode, tColor, fuzz].forEach(el => el.oninput = process);
            stage.onwheel = e => { e.preventDefault(); scale *= e.deltaY > 0 ? 0.9 : 1.1; render(); };
            document.getElementById('reset').onclick = () => location.reload();
        })();
    </script>
</body>
</html>
