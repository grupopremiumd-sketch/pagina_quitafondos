<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quitar Fondo â€” J&J Studio Pro</title>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --text:#eeeeee; --muted:#9ca3af;
      --accent:#6e7cff; --accent-2:#0ea5e9; --border:#1f1f1f;
      --success-1:#10b981; --success-2:#22c55e; --success-3:#34d399;
      --overlay:rgba(0,0,0,.55); --vip:#00d2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:#0b0b0b;position:sticky;top:0;z-index:10}
    header h1{font-size:15px;margin:0;font-weight:900;letter-spacing:.5px;color:var(--vip)}
    .badge{margin-left:auto; font-size:10px; padding:3px 8px; border-radius:999px; background:#1e1e1e; border:1px solid #333; color:#888; font-weight:bold;}
    .badge-vip{border-color:var(--vip); color:var(--vip); background:rgba(0,210,255,0.1);}

    .wrap{display:grid;grid-template-columns:350px 1fr;gap:16px;min-height:calc(100vh - 58px);padding:16px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr;}}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .panel h2{font-size:12px;font-weight:800;margin:0 0 8px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    .panel .body{padding:14px}
    .panel .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:10px 0}
    .panel label{font-size:13px;color:#e5e7eb}
    
    .panel input[type="color"], .panel select, .panel input[type="number"], .panel button, .panel input[type="file"]{
      background:#1a1a1a;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;outline:none;
    }
    .panel button{cursor:pointer;font-weight:700}
    .panel .muted{color:var(--muted);font-size:11px}

    .canvasWrap{position:relative;padding:10px;background:#0b0b0b;border:1px solid var(--border);border-radius:12px}
    .stage{position:relative;overflow:hidden;border-radius:10px;height:82vh;background:#0f0f0f}
    canvas#canvas{ display:block; transition:transform .08s ease; transform-origin: top left; }
    canvas#overlay{position:absolute;inset:0; pointer-events:none; cursor:default;}

    .btn-nav{ width:100%; background:#222; color:var(--vip); border:1px solid var(--vip); padding:10px; border-radius:8px; margin-bottom:15px; cursor:pointer; font-weight:bold; font-size:11px; }
    .btn-download{ background: linear-gradient(135deg, var(--success-1), var(--success-2)); border:none;color:#052e1a;padding:12px;border-radius:8px;cursor:pointer;font-weight:900; width:100%; margin-top:10px; }

    .cp-wrap{display:flex;gap:10px;align-items:flex-start}
    #cpSV{border-radius:6px;border:1px solid #2a2a2a;cursor:crosshair;touch-action:none}
    #cpH{border-radius:6px;border:1px solid #2a2a2a;cursor:ns-resize;touch-action:none}
    .kbd{font:10px monospace;background:#161616;border:1px solid #262626;padding:2px 4px;border-radius:4px;color:#888}
    .hidden{display:none!important}

    /* Modales J&J */
    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(400px,92vw);background:#121212;border:1px solid #262626;border-radius:14px;padding:20px;text-align:center;}
    .choice-card{background:#1a1a1a; border:1px solid #333; padding:15px; border-radius:10px; cursor:pointer; margin-bottom:10px; display:flex; align-items:center; gap:12px; text-align:left;}
    .choice-card:hover{border-color:var(--vip); background:#222;}
  </style>
</head>
<body>

  <div id="vip-modal" class="modal-backdrop hidden">
    <div class="modal">
      <h3 style="color:var(--vip)">Acceso VIP Requerido</h3>
      <p class="muted" style="margin-bottom:20px">Para descargar en alta resoluciÃ³n elige una opciÃ³n:</p>
      <div class="choice-card" onclick="openLogin()">
        <span style="font-size:20px">ðŸ’Ž</span>
        <div><div style="font-weight:bold">Ya soy Socio VIP</div><div class="muted">Ingresa tus credenciales</div></div>
      </div>
      <div class="choice-card" onclick="window.open('https://wa.me/51916689969','_blank')">
        <span style="font-size:20px">ðŸ“²</span>
        <div><div style="font-weight:bold; color:#22c55e">Activar SuscripciÃ³n</div><div class="muted">Habla con un asesor</div></div>
      </div>
      <button onclick="document.getElementById('vip-modal').classList.add('hidden')" style="background:none; border:none; color:#555; cursor:pointer; margin-top:10px">Cancelar</button>
    </div>
  </div>

  <header>
    <h1>J&J STUDIO PRO</h1>
    <div class="badge" id="vip-tag">INVITADO</div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="body">
        <button class="btn-nav" onclick="location.href='simulador.html'">âœ¨ IR AL SIMULADOR</button>
        <h2>Cargar imagen</h2>
        <div class="row"><input id="file" type="file" accept="image/*"></div>
        <p class="muted">Arrastra o pega con <span class="kbd">Ctrl+V</span>.</p>
      </div>

      <hr style="border-color:var(--border);opacity:.2">

      <div class="body">
        <h2>ConfiguraciÃ³n</h2>
        <div class="row">
          <label>Modo</label>
          <select id="mode">
            <option value="white">Quitar fondo blanco</option>
            <option value="black">Quitar fondo negro</option>
            <option value="pick">Elegir color (clic imagen)</option>
            <option value="auto">Auto (esquinas)</option>
          </select>
        </div>
        <div class="row"><label>Tolerancia</label><input id="fuzz" type="range" min="0" max="200" value="60"></div>
        <div class="row"><label>Suavizado</label><input id="feather" type="range" min="0" max="10" step="0.1" value="0.8"></div>
        
        <h2 style="margin-top:20px">Color del lienzo</h2>
        <div class="cp-wrap">
          <canvas id="cpSV" width="220" height="100"></canvas>
          <canvas id="cpH" width="20" height="100"></canvas>
        </div>
      </div>

      <div class="body">
        <button id="btnCrop" style="width:48%">Recortar</button>
        <button id="reset" style="width:48%; background:transparent">Reiniciar</button>
        <button id="download" class="btn-download">DESCARGAR PNG VIP</button>
        <div id="crop-btns" class="hidden" style="margin-top:10px">
            <button id="btnApplyCrop" style="background:var(--success-1); color:#000; width:100%">Aplicar Recorte</button>
        </div>
      </div>
    </section>

    <section class="canvasWrap">
      <div class="stage" id="stage">
        <canvas id="canvas"></canvas>
        <canvas id="overlay"></canvas>
      </div>
      <p class="muted" style="margin-top:10px">Zoom: Rueda mouse Â· Mover: Espacio + Arrastrar Â· Deshacer: Ctrl+Z</p>
    </section>
  </main>

  <script>
    // --- INTEGRACIÃ“N J&J STUDIO ---
    let isVip = localStorage.getItem('jj_session') === 'active';
    if(isVip) {
      document.getElementById('vip-tag').innerText = "SOCIO VIP ACTIVO";
      document.getElementById('vip-tag').classList.add('badge-vip');
    }

    const file = document.getElementById('file'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay'), octx2 = overlay.getContext('2d'), stage = document.getElementById('stage');
    const mode = document.getElementById('mode'), fuzz = document.getElementById('fuzz'), feather = document.getElementById('feather');
    
    let ocanvas = document.createElement('canvas'), octx = ocanvas.getContext('2d');
    let scale=1, offsetX=20, offsetY=20, lastOut=null;
    let history=[];

    // --- CARGAR IMAGEN ---
    file.onchange = e => {
      const f = e.target.files[0];
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = () => {
        ocanvas.width = img.width; ocanvas.height = img.height;
        octx.drawImage(img,0,0);
        fitCanvas(); processNow();
      };
      img.src = url;
    };

    function fitCanvas(){
      canvas.width = ocanvas.width; canvas.height = ocanvas.height;
      scale = Math.min(stage.clientWidth/canvas.width, stage.clientHeight/canvas.height, 0.9);
      render();
    }

    function processNow(){
      if(!ocanvas.width) return;
      const fVal = +fuzz.value, feVal = +feather.value;
      const src = octx.getImageData(0,0,ocanvas.width,ocanvas.height), s = src.data;
      const out = ctx.createImageData(ocanvas.width,ocanvas.height), o = out.data;
      
      let target = [255,255,255];
      if(mode.value==='black') target=[0,0,0];

      const threshold = fVal * 2.5;
      for(let i=0; i<s.length; i+=4){
        const dist = Math.sqrt((s[i]-target[0])**2 + (s[i+1]-target[1])**2 + (s[i+2]-target[2])**2);
        o[i]=s[i]; o[i+1]=s[i+1]; o[i+2]=s[i+2];
        o[i+3] = dist < threshold ? 0 : s[i+3];
      }
      lastOut = out; render();
    }

    function render(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(lastOut) ctx.putImageData(lastOut,0,0);
      canvas.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`;
    }

    // --- DESCARGA CON BLOQUEO VIP ---
    document.getElementById('download').onclick = () => {
      if(!isVip) {
        document.getElementById('vip-modal').classList.remove('hidden');
      } else {
        const a = document.createElement('a');
        a.download = 'jj_studio_pro.png';
        a.href = canvas.toDataURL();
        a.click();
      }
    };

    // --- BG PICKER ---
    const cpSV=document.getElementById('cpSV'), cpH=document.getElementById('cpH');
    let hue=0;
    function drawCP(){
      const gH=cpH.getContext('2d'); const grd=gH.createLinearGradient(0,0,0,100);
      for(let i=0;i<=360;i+=10) grd.addColorStop(i/360, `hsl(${i},100%,50%)`);
      gH.fillStyle=grd; gH.fillRect(0,0,20,100);
    }
    drawCP();
    cpH.onmousedown = e => {
      const r = cpH.getBoundingClientRect();
      hue = ((e.clientY - r.top)/100)*360;
      stage.style.background = `hsl(${hue}, 50%, 10%)`;
    };

    // --- EVENTOS ---
    [mode, fuzz, feather].forEach(el => el.oninput = processNow);
    stage.onwheel = e => { e.preventDefault(); scale *= e.deltaY > 0 ? 0.9 : 1.1; render(); };
  </script>
</body>
</html>
